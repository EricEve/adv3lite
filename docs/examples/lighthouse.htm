<html>
<!-- DERIVED FILE - DO NOT EDIT -->
<html><head><link rel="StyleSheet" href="main.css" type="text/css" media="screen"> 
<head>
<title>Exercise 20 (adv3)</title>
</head>
<body>
<div class="nav">
  <a class="nav" href="exercises.htm">Examples Index</a> | <a href='Exercise20.htm'>adv3Lite version</a>
  
  </div>
  <hr>

<h1>Exercise 20 - Actors and Conversation (adv3)</h1>

<p>LIGHTHOUSE is an adv3 demo designed to illustrate implementing NPCs in 
adv3Lite. It's loosely inspired by the Bop character used as an example in
Mike Roberts's &quot;Creating Dynamic Actors&quot; article in the Technical Manual.</p>
 
 <p>There's a couple of endings you can reach, but you can't really win. As 
 with all these demos the point isn't playing the game but learning from 
 the sourc code (although as ever it's worth trying to play it to see 
 what the code does).</p>

<p>The game follows the specification of Exercise 20 in <i>Learning TADS 3</i>:

<p>Both the NPC articles in the TADS 3 Technical Manual and several of those in this chapter refer to a character called Bob who stacks cans and mutters darkly about a lighthouse and some “troubles”, so try writing a small game based on that. Here’s some further suggestions: The player character is new to the town and has just gone into Bob’s shop, where Bob is busily stacking cans and a blonde woman (let’s call her Sally) is inspecting the clothes on the clothes rack. Sally is too interested in the clothes to engage a stranger in conversation, but Bob is more talkative. You can ask him about a number of topics, but if you ask him about the town, he’ll mention the lighthouse and the troubles, and then clam up on those topics. When Sally hears Bob mention the troubles she goes outside. When the player character leaves the shop Sally comes up to him and asks whether he wants her to show him the lighthouse. The player can reply yes or no or ask why she’s offering. If the player replies yes, Sally leads the player character to the lighthouse and then invites him to lead the way inside. On the lowest floor of the lighthouse there’s nothing but an abandoned storeroom and an abandoned office, which Sally comments on the first time she follows the player character there. Halfway up a spiral staircase is an oak door. When the player character goes through the door he meets more than he bargained for.</p>

<div class='code'><pre>
#charset &quot;us-ascii&quot;

<span class='comment'>/*   
 *   LIGHTHOUSE is a TADS 3 demo designed to illustrate implementing NPCs in 
 *   TADS 3. It's loosely inspired by the Bop character used as an example in
 *   Mike Roberts's &quot;Creating Dynamic Actors&quot; article in the Technical 
 *   Manual.
 *
 *   There's a couple of endings you can reach, but you can't really win. As 
 *   with all these demos the point isn't playing the game but learning from 
 *   the sourc code (although as ever it's worth trying to play it to see 
 *   what the code does).
 */</span>


<span class='comment'>/*
 *   Copyright (c) 1999, 2002 by Michael J. Roberts.  Permission is
 *   granted to anyone to copy and use this file for any purpose.  
 *   
 *   This is a starter TADS 3 source file.  This is a complete TADS game
 *   that you can compile and run.
 *   
 *   To compile this game in TADS Workbench, open the &quot;Build&quot; menu and
 *   select &quot;Compile for Debugging.&quot;  To run the game, after compiling it,
 *   open the &quot;Debug&quot; menu and select &quot;Go.&quot;
 *   
 *   This is the &quot;advanced&quot; starter game - it has only the minimum set of
 *   definitions needed for a working game.  If you would like some more
 *   examples, create a new game, and choose the &quot;introductory&quot; version
 *   when asked for the type of starter game to create.  
 */</span>

<span class='comment'>/* 
 *   Include the main header for the standard TADS 3 adventure library.
 *   Note that this does NOT include the entire source code for the
 *   library; this merely includes some definitions for our use here.  The
 *   main library must be &quot;linked&quot; into the finished program by including
 *   the file &quot;adv3.tl&quot; in the list of modules specified when compiling.
 *   In TADS Workbench, simply include adv3.tl in the &quot;Source Files&quot;
 *   section of the project.
 *   
 *   Also include the US English definitions, since this game is written
 *   in English.  
 */</span>
#include &lt;adv3.h&gt;
#include &lt;en_us.h&gt;

<span class='comment'>/*
 *   Our game credits and version information.  This object isn't required
 *   by the system, but our GameInfo initialization above needs this for
 *   some of its information.
 *   
 *   You'll have to customize some of the text below, as marked: the name
 *   of your game, your byline, and so on.
 */</span>
versionInfo: GameID
    IFID = 'f5a02ab4-71ec-80f5-83be-a83324c66bac'
    name = 'The Lighthouse'
    byline = 'by Eric Eve'
    htmlByline = 'by &lt;a href=&quot;mailto:eric.eve@hmc.ox.ac.uk&quot;&gt;
                  Eric Eve&lt;/a&gt;'
    version = '0.3'
    authorEmail = 'Eric Eve &lt;eric.eve@hmc.ox.ac.uk&gt;'
    desc = 'A short game to demonstrate programming NPCs in TADS 3'
    htmlDesc = 'A short game to demonstrate programming NPCs in TADS 3'
;

<span class='comment'>/*
 *   The &quot;gameMain&quot; object lets us set the initial player character and
 *   control the game's startup procedure.  Every game must define this
 *   object.  For convenience, we inherit from the library's GameMainDef
 *   class, which defines suitable defaults for most of this object's
 *   required methods and properties.  
 */</span>
gameMain: GameMainDef
    <span class='comment'>/* the initial player character is 'me' */</span>
    initialPlayerChar = me
    showIntro()
    {
        &quot;You've only just moved into town, so you thought you'd pay the local
        store a visit to pick up some basic essentials. But you may be about to
        get more than you bargained for.\b&quot;;
    }
    
    showGoodbye()
    {
        if(me.hasSeen(horrorChamber))
            &quot;&lt;.p&gt;Sorry, that's all folks! &quot;;
        else
            &quot;&lt;.p&gt;Perhaps you should try a bit harder next time! &quot;;
    }
;

<span class='comment'>/* 
 *   Starting location - we'll use this as the player character's initial
 *   location.  The name of the starting location isn't important to the
 *   library, but note that it has to match up with the initial location
 *   for the player character, defined in the &quot;me&quot; object below.
 *   
 *   Our definition defines two strings.  The first string, which must be
 *   in single quotes, is the &quot;name&quot; of the room; the name is displayed on
 *   the status line and each time the player enters the room.  The second
 *   string, which must be in double quotes, is the &quot;description&quot; of the
 *   room, which is a full description of the room.  This is displayed when
 *   the player types &quot;look around,&quot; when the player first enters the room,
 *   and any time the player enters the room when playing in VERBOSE mode.
 *
 */</span>
shop: Room 'General Store'
    &quot;The shop has much the sort of stuff you'd expect in a general store in a
    sleepy sea-side town like this. The only way out is to the north. &quot;
    north = street
    out asExit(north)
    
    <span class='comment'>/* 
     *   followDesc is a custom property we are defining for use with an 
     *   accompanying NPC (see below). It's used to customize what's 
     *   displayed when the sally NPC accompanies the PC via a particular 
     *   connector.
     */</span>
    followDesc = 'back into the shop'
;

<span class='comment'>/*   
 *   Since this is a demo of NPCs, we'll keep the implementation of the map 
 *   and the physical objects in it as basic as possible, more or less to 
 *   the bare minimum needed to illustrate the various features of NPC 
 *   programming. For the same reason we'll only provide minimal commenting 
 *   for the map-building section of the code.
 *
 *   We don't need multiple rooms to illustrate conversation, but we do need 
 *   multiple rooms to illustrate an NPC who accompanies the PC on his 
 *   travels, so we'll still need several rooms in this map.
 */</span>


+ Decoration 'clothes rack' 'clothes rack'
    &quot;It's a rack with lots of clothes on. &quot;
;

+ cans: Decoration 'carefully stacked stack/can/cans' 'cans'
    &quot;The cans are all carefully stacked. &quot;
    isPlural = true
;


<span class='comment'>/*
 *   PLAYER CHARACTER ACTOR
 *
 *   Define the player character.  The name of this object is not important, 
 *   but it MUST match the name we use to initialize 
 *   gameMain.initialPlayerChar above.
 *
 *   Note that we aren't required to define any vocabulary or description 
 *   for this object, because the class Actor, defined in the library, 
 *   automatically provides the appropriate definitions for an Actor when 
 *   the Actor is serving as the player character.  Note also that we don't 
 *   have to do anything special in this object definition to make the Actor 
 *   the player character; any Actor can serve as the player character, and 
 *   we'll establish this one as the PC in main(), below.  
 */</span>
+ me: Actor
;

street: OutdoorRoom 'Main Street'
    &quot;This looks the main street running through the town. At this point it runs
    past the general store immediately to the south. The town centre lies to the
    west, while to the east the street runs on out of town. &quot;
    south = shop
    in asExit(south)
    west: DeadEndConnector { 
        -&gt; 'the town centre'
       &quot;You wander round the town centre for a while, but find nothing that
       holds your attention, so you eventually find your feet bringing you
       back where you started. &quot; }
    east: OneWayRoomConnector {
        -&gt; road
        followDesc = 'along the street all the way out of town, and then on
            down the road'
    }
;

road: OutdoorRoom 'Road'
    &quot;The road seems unusually quiet, with very little traffic; right now
    there's none in sight at all. It runs fairly straight here, almost dead
    straight back into the town to the west, although you can see it start to
    bend some way off to the east. An open field lies to the south. &quot;
    west = street
    east: DeadEndConnector { &quot;You walk a short way down the road, then turn
        round and come back. &quot;}
    south: OneWayRoomConnector {
        -&gt;hillTop
        followDesc = 'away from the road, across a field and up a shallow hill'
    }
;

+ Enterable -&gt;(road.south) 'open field' 'open field'
    &quot;It slopes gently up to the east. &quot;
;


hillTop: OutdoorRoom 'Hilltop'
    &quot;From the top of the hill you can clearly see the sea glinting a short way
    to the south. It looks possible to descend the hill to the southeast, the
    southwest, or the north. &quot;
    southeast: OneWayRoomConnector {
        -&gt; cliff
        followDesc = 'down the far side of the hill, and carry on a short way
        towards the coast'
    }
    southwest: DeadEndConnector {
        -&gt; 'the sheer cliff'
        &quot;You walk a short way down to the southwest, but soon come to a sheer
        cliff overlooking the sea. Since you can go no further in that direction
        you turn round and come back. &quot;
    }
    north = road
    followDesc = 'back up the hill'
;

MultiLoc, Distant 'wet watery calm sea' 'sea'
    &quot;It looks as wet and watery as the sea always does, though it also looks
    reasonably calm. &quot;
    locationList = [cliff, cliffPath, hillTop]
    aName = 'the sea'
;

cliff: OutdoorRoom 'Lonely Cliff'
    &quot;The path down the hillside to the northwest comes to an end on this bleak
    stretch of cliff, overlooking the sea several dozen yards below. An old
    lighthouse, perched strategically near the cliff-edge, stands immediately
    to the east. To the west a narrow path snakes precariously along the
    cliff-top. &quot;
    northwest = hillTop
    
    east = lhDoor
    in asExit(east)
    west = narrowPath
;

+ lighthouse: Enterable -&gt;lhDoor 'damaged old lighthouse' 'lighthouse'
    &quot;The lighthouse is still standing, but it looks as if the upper part has
    sustained some damage. &quot;
;

++ lhDoor: Door 'door' 'door'
    followDesc = 'through the door into the lighthouse'
;

+ narrowPath: PathPassage 'narrow path' 'narrow path'
    &quot;It snakes precariously along the cliff-top to the west. &quot;
    destination = cliffPath
    followDesc = 'down the narrow path'
;

cliffPath: OutdoorRoom 'Cliff Path'
    &quot;The path from the northwest comes to a dead end overlooking the sea. &quot;
    northwest = cliff    
;

lobby: Room 'Lighthouse Lobby'
    &quot;This would seem to be the entrance lobby for the lighthouse. A spiral
    staircase winds up to the north, and the way out is to the west, while a
    second exit leads east. &quot;
    west = lhDoorInside
    out asExit(west)
    north = lhStair
    up asExit(north)
    east = store
    
    followDesc = 'back into the lobby'
;

+ lhDoorInside: Door -&gt;lhDoor 'door' 'door'
    followDesc = 'back out through the door'
;

+ lhStair: StairwayUp 'spiral flight/stairs/staircase' 'flight of stairs'
    followDesc = 'up the stairs'

;    

store: Room 'Storeroom' 
    &quot;This looks as if it was once a storeroom for the lighthouse, but it's been
    stripped almost bare now. The exit back to the lobby is to the west, but
    there's another exit to the south. &quot;
    west = lobby
    south = office
    out asExit(west)
    followDesc = 'into the storeroom'
;

office: Room 'Office'
    &quot;The battered old wooden desk standing in the corner suggests that this was
    once an office of some sort, but there's little else here now. The only way
    out is to the north. &quot;
    north = store
    out asExit(north)
    followDesc = 'into the office'
;

+ Surface, Heavy 'battered old wooden desk' 'desk'
    &quot;It has certainly seen better days. &quot;
;


midStair: Room 'On the Staircase'
    &quot;About halfway up the lighthouse the spiral staircase passes an oak door
    to the east. &quot;
    down = midStairDown
    up = midStairUp
    east = oakDoor
;

+ midStairDown: StairwayDown -&gt;lhStair 'descending down spiral staircase/stairs' 
    'descending staircase'
    followDesc = 'back down the staircase'
;

+ midStairUp: StairwayUp 'ascending up spiral staircase/stairs' 
    'ascending staircase'
    dobjFor(TravelVia)
    {
        action()
        {
            &quot;You only get a short way further up the staircase before
            discovering that the way has been blocked by falling masonry, so
            you are forced to turn round and come back. &quot;;
        }
    }
;

+ oakDoor: Door 'oak door*doors' 'oak door'
    followDesc = 'through the door'
;

horrorChamber: Room 'Chamber of Horrors'
    <span class='comment'>/* 
     *   Normally it would be a bad idea to include a description of the PC's
     *   first reaction to a location in the desc property (we should 
     *   normally use roomFirstDesc for this), but since this room 
     *   description will only ever be displayed once, when the PC first 
     *   enters this room, it doesn't matter here.
     */</span>
    &quot;The sight that meets your eyes as you walk into this chamber astonishes,
    disgusts and terrifies you all at once. You are literally struck dumb with
    horror. You didn't know what to expect, but never in your wildest nightmares
    did you ever imagine anything like &lt;i&gt;this&lt;/i&gt;...&quot;
    east = horrorDoor
    out asExit(east)
;

+ horrorDoor: Door -&gt;oakDoor 'door' 'door'
;

//==============================================================================
<span class='comment'>/*   
 *   CLASS DEFINITION
 *
 *   Later in the game we'll be creating Can objects dynamically, so we need 
 *   to define a Can class.
 */</span>

class Can: Thing 'round aluminium tin can/tin*cans*tins' 'can'
    &quot;It's round and made of tin -- or maybe aluminium. &quot;
    
    <span class='comment'>/* One can is much like any other - we don't need to distinguish them. */</span>
    isEquivalent = true
    
    <span class='comment'>/* 
     *   We want to keep track of the total number of Cans we've created, so 
     *   we do this in the construct() method. Note that we keep this count 
     *   on the Can class, not on individual Can objects.
     */</span>
    construct()
    {
        inherited();
        Can.cansCreated ++;
    }
    cansCreated = 0
;


//==============================================================================
<span class='comment'>/*  
 *   THE MAIN NPC CODE STARTS HERE
 *
 *   There'll be two NPCs in this game. Bob, the shopkeeper, will be used to 
 *   demonstrate the standard method of implementing conversations in TADS 
 *   3. Sally, the other, will be used to illustrate an NPC who accompanies 
 *   the PC on his travel, as well as other features such as AgendaItems and 
 *   Conversation Nodes. 
 *
 *
 *   We'll start by modifying the standard library Person class to provide 
 *   some tweaks we should find useful.
 */</span>


modify Person
    <span class='comment'>/* 
     *   We often don't know the name of NPCs when we first encounter them, 
     *   so that to begin with they have generic descriptions like 'a tall 
     *   man' or 'a blonde woman'. But once the PC knows an NPC's proper 
     *   name, that's the name that should be used. makeProper() is a custom 
     *   method we define to handle giving an NPC a proper name once we know 
     *   what it is.
     */</span>
    
    makeProper()
    {
        <span class='comment'>/* 
         *   isProperName is a standard library class; by setting it to true 
         *   we tell the parser not to display an article (&quot;a&quot; or &quot;the&quot;) 
         *   with the actor's name; &quot;a man&quot; or &quot;the woman&quot; is fine, but once 
         *   they have proper names they should be called &quot;Bob&quot; and &quot;Sally&quot;, 
         *   not &quot;a Bob&quot; or &quot;the Sally&quot;.
         */</span>
        isProperName = true;
        
        <span class='comment'>/*   
         *   Set the name property (a standard library property) to the 
         *   value of the properName property (a custom property we define 
         *   below, and which would need to be overridden on each actor with 
         *   the name of that actor).
         */</span>
        name = properName;
        
        <span class='comment'>/*   
         *   Ensure that the parser will recognize the properName as 
         *   referring to this actor.
         */</span>
        initializeVocabWith(properName.toLower());
        
        <span class='comment'>/*   
         *   Return the properName to the caller, so it can be used in 
         *   constructions like &quot;&lt;q&gt;Hi, I'm &lt;&lt;properName&gt;&gt;,&lt;/q&gt; the man 
         *   introduces himself.
         */</span>
        return properName;
    }
    
    <span class='comment'>/* 
     *   properName is a custom property we define to contain the NPC's 
     *   proper name -- what he or she will be known by once the PC knows 
     *   his or her name.
     */</span>
    properName = nil

    <span class='comment'>/*  
     *   The first time an actor's mentioned we expect him or her to be 
     *   described with the indefinite object (&quot;A tall man is standing 
     *   here&quot;); thereafter we'd expect to see the definite article (&quot;The 
     *   tall man is standing here&quot;). We therefore override theName (and add 
     *   a custom previouslyMentioned property) to produce this effect; the 
     *   first time theName is called it will return aName; thereafter it 
     *   will return the inherited version of theName.
     */</span>
    
    timesMentioned = 0
    theName = (timesMentioned++ ? inherited : aName)
    
    <span class='comment'>/*  
     *   There aren\'t many portable objects in this game (unless the player 
     *   start collecting cans from Bob), but the standard library response 
     *   for throwing things at things is quite inappropriate when the 
     *   target is a person, (e.g. &quot;The can hits Bob without any obvious 
     *   effect and falls to the floor&quot;) that we should in any case override 
     *   it.
     */</span>
    
    iobjFor(ThrowAt)
    {
        check()
        {
            failCheck('You\'re not a child throwing a tantrum; you know better
                than to start throwing things at people. ');
        }
    }
    
;

//==============================================================================
<span class='comment'>/*  
 *   CODE FOR THE BOB NPC 
 *
 *   There's usually a lot of code and objects associated with an NPC, so 
 *   where an NPC is at all complex it's best to keep the NPC code separate 
 *   from the rest of the room and game code.
 *
 *   PERSON
 *
 *   There's not much to define on the Person object itself, since most of 
 *   Bob's behaviour will be implemented in his ActorStates and Topic 
 *   Entries. 
 */</span>

bob: Person 'tall man*people' 'tall man' @shop
    &quot;He's a man with a gaunt face and a slight stoop; you'd estimate he was
    nearer sixty than fifty. &quot;
       
    <span class='comment'>/* Remember, this is a custom property. We just defined it above/ */</span>
    properName = 'Bob'
    
    <span class='comment'>/* Bob is male. */</span>
    isHim = true
    
    <span class='comment'>/* 
     *   It's useful to define a globalParamName on an NPC, so we can refer 
     *   to him or her in paramater substitution string (such as '{the 
     *   bob/he}'). This is particular useful when the name of the NPC might 
     *   change in the course of play (e.g. from 'the tall man' to 'Bob' if 
     *   and when we learn Bob's name), but we don't know in advance when 
     *   this will happen. 
     */</span>
    globalParamName = 'bob'
    
    <span class='comment'>/*   Customize the responses for ATTACK/HIT/KICK/KILL BOB and KISS BOB */</span>    
    uselessToAttackMsg = 'There seems to be no call for violence. '
    cannotKissActorMsg = 'Neither of you would enjoy that very much. '
    
;

<span class='comment'>/*  
 *   UNTHING
 *
 *   It's debatable whether the player who already knows that the tall man is
 *   called Bob should be able to refer to him as 'Bob' before the player 
 *   character has officially learned his name. In this example we're 
 *   assuming not, but you may well prefer to do things differently in your 
 *   own games, (in which case just include 'bob' or whatever in the NPC's 
 *   vocabWords property when you first define him or her.
 *
 *   But the problem then is what to do when the player does try to refer to 
 *   Bob before the PC has learned his name. If we haven't defined 'bob' in 
 *   bob's vocabWords the game will respond with &quot;The word &ldquo;bob&rdquo; is not 
 *   necessary in this story. &quot;, but that's simply untrue!
 *
 *   One way to get round this is with this little trick using an Unthing, 
 *   which we attach to Bob so it's always in scope when Bob is in scope. 
 *   Then if the player tries to refer to Bob before Bob has been named, 
 *   s/he'll get the response &quot;You don't know anyone called Bob yet&quot;, which 
 *   is at least better than the default. Once Bob has named, the Unthing 
 *   will simply be ignored (since the parser always prefers any other 
 *   object to an Unthing if one is available).
 */</span>


+ Unthing 'bob' 'bob'
    'You don\'t know anyone called Bob yet. '
;

<span class='comment'>/*   
 *   IN CONVERSATION STATE
 *
 *   To implement a conversation with Bob, we start by defining his 
 *   InConversationState, the ActorState he's in when conversing with the 
 *   player character
 */</span>


+ bobTalking: InConversationState
    <span class='comment'>/* 
     *   The specialDesc defines how Bob will be described in a room 
     *   description when he's in this ActorState. Note the use of {The 
     *   bob/he} which will expand to either 'Bob' or 'The tall man', 
     *   depending on whether or not the PC has yet learned Bob's name.
     */</span>
    specialDesc = &quot;{The bob/he} is standing facing you, with one hand on his
        hip and the other holding a can. &quot;
    
;

<span class='comment'>/*  
 *   CONVERSATION READY STATE
 *
 *   The ConversationReadyState is the ActorState Bob is in when he's not 
 *   actually engaged in conversation, but can be. When the PC talks to Bob, 
 *   Bob will switch to the associated InConversationState.
 *
 *   We could set the appropriate properties of bobTalking and bobStacking to
 *   point to each other, but locating the ConversationReadyState in the 
 *   InConversationState saves us the bother. This way, the library knows 
 *   that bobStacking is the ConversationReadyState associated with 
 *   bobTalking (and vice versa).
 *
 *   To keep things simple we are defining only one ConversationReadyState/ 
 *   InConversationState pair for Bob, but in your own game you can have as 
 *   many as you like. To switch ActorStates under programmatic control use 
 *   bob.setCurState(newState).
 */</span>

++ bobStacking: ConversationReadyState
    <span class='comment'>/* This is the state Bob starts out in. */</span>
    isInitState = true
    
    <span class='comment'>/* 
     *   commonDesc is not a library property; it's a custom property we're 
     *   defining to avoid the need to duplicate text in the specialDesc and 
     *   stateDesc properties.
     */</span>
    commonDesc = 'busily stacking cans at the rear of the shop'
    
    <span class='comment'>/*   
     *   How Bob will be mentioned in a room description when he's in this 
     *   state.
     */</span>
    specialDesc = &quot;{The bob/he} is &lt;&lt;commonDesc&gt;&gt;. &quot;
    
    <span class='comment'>/*   
     *   The stateDesc will be added to the end of the description provided 
     *   by bob.desc when Bob is in this ActiveState and the player examines 
     *   Bob.
     */</span>
    stateDesc = &quot;He's &lt;&lt;commonDesc&gt;&gt;. &quot;    
;

<span class='comment'>/*
 *   HELLO TOPIC
 *
 *   A HelloTopic is used to handle Bob's response to BOB, HI, or TALK TO 
 *   BOB, when Bob is in this ConversationReadyState. Since we're not also 
 *   defining an ImpHelloTopic it will also be used when the PC addresses 
 *   any conversational command to Bob (e.g. ASK MAN ABOUT THE WEATHER) 
 *   while he's in the ConversationReadyState, in which case the 
 *   conversational exchange defined in the HelloTopic will occur before the 
 *   specific topic asked about is handled (and Bob will then switch into his
 *   InConversationState. 
 *
 *   Note that HelloTopics (and ByeTopics) are normally located in a 
 *   ConversationReadyState.
 *
 *   By combining HelloTopic with  StopEventList we can vary the response Bob
 *   gives each time he is addressed. 
 */</span>

+++ HelloTopic, StopEventList
    [
        '&lt;q&gt;Hello there!&lt;/q&gt; you say.\b
        &lt;q&gt;Good morning, sir,&lt;/q&gt; he replies, turning to you. ',
        
        '&lt;q&gt;Excuse me,&lt;/q&gt; you say.\b
        &lt;q&gt;Yes?&lt;/q&gt; he replies, turning to face you. ',
        
        '&lt;q&gt;Hello again,&lt;/q&gt; you greet him.\b
        &lt;q&gt;Good morning once more, sir,&lt;/q&gt; he answers, as he turns to face
        you. '
    ]
;

<span class='comment'>/*
 *   BYE TOPIC
 *
 *   We use a ByeTopic to end a conversation just as we use a HelloTopic to 
 *   begin with. Since we're also defining an ImpByeTopic, this ByeTopic will
 *   only be triggered in the player explicitly bids Bob goodbye (e.g. with 
 *   a BYE command). Note that like HelloTopics, ByeTopics are normally 
 *   located in a ConversationReadyState. If the PC bids Bob goodbye while 
 *   Bob is in the corresponding InConversationState, Bob will switch to the 
 *   ConversationReadyState and this farewell message will be displayed.
 */</span>    
+++ ByeTopic
    &quot;&lt;q&gt;Well, cheerio then!&lt;/q&gt; you say.\b
    &lt;q&gt;Good day, sir,&lt;/q&gt; {the bob/he} replies, before returning to his stack
    of cans. &quot;
;

<span class='comment'>/*   
 *   IMP BYE TOPIC
 *
 *   An ImpByeTopic is just like a ByeTopic, except that it is triggered 
 *   when a conversation is terminated other than with an explicit GOODBYE. 
 *   This may happen if the Player Character simply walks away in the middle 
 *   of the conversation, or if s/he fails to address Bob for so many turns 
 *   (defined in the InConversationState's attentionSpan property) and Bob 
 *   gets bored waiting for the PC to speak. If we want to distinguish 
 *   between these two implicit Bye cases we can use LeaveByeTopic and 
 *   BoredByeTopic, but here we'll just use an ImpByeTopic to cover both 
 *   cases. 
 */</span>

+++ ImpByeTopic
    &quot;{The bob/he} turns away and resumes stacking cans. &quot;
;

<span class='comment'>/*   
 *   ASK TOPIC
 *
 *   SUGGESTED ASK TOPIC
 *
 *   Note that we've finished with the ConversationReadyState: all the 
 *   following TopicEntries are located in the InConversationState.
 *
 *   An AskTopic is used to respond to a question such as ASK BOB ABOUT 
 *   WHATEVER (which can be abbreviated to A WHATEVER one a conversation is 
 *   underway). The AskTopic defined below will match the question ASK BOB 
 *   ABOUT LIGHTHOUSE (because 'lighthouse' is defined in the vocabWords of 
 *   the lighthouse object). But note that the PC must first know about the 
 *   lighthouse before this topic becomes available.
 *
 *   By making this AskTopic also a SuggestedAskTopic we include it in the 
 *   topic inventory - the list of suggested topics for conversation 
 *   displayed in response to a TOPICS command or to TALK ABOUT BOB. Note 
 *   that the topic will only be suggested when the TopicEntry becomes 
 *   available, i.e. when the PC knows about the lighthouse.
 */</span>
++ AskTopic, SuggestedAskTopic @lighthouse
    &quot;&lt;q&gt;So what happened at the lighthouse?&lt;/q&gt; you wanted to know.\b
    &lt;q&gt;Well,&lt;/q&gt; he begins, &lt;q&gt;it was like this -- all those years ago...&lt;/q&gt; he
    breaks off, as if wrestling with himself, then suddenly snaps, &lt;q&gt;Just don't
    go there, that's all!&lt;/q&gt; &quot;
    
    <span class='comment'>/* The name we use to describe this topic in a list of suggested topics. */</span>
    name = 'the lighthouse'
;

<span class='comment'>/*
 *   TELL TOPIC
 *
 *   SUGGESTED TELL TOPIC
 *
 *   TellTopic is the converse of AskTopic. It defines the response to a 
 *   command like TELL BOB ABOUT WHATEVER (in this case TELL BOB ABOUT 
 *   MYSELF or T MYSELF). We combine it with SuggestedTellTopic so that it 
 *   appears in a list of suggested topics (note we don't have to do this; 
 *   it's up to the game author whether a particular TopicEntry should be 
 *   suggested or not). 
 *
 *   By combining the TellTopic with ShuffledEventList we can vary the 
 *   response. This is often a good idea for creating more life-like NPCs.
 */</span>
++ TellTopic, SuggestedTellTopic, ShuffledEventList @me
    <span class='comment'>/* 
     *   When we define two lists for a ShuffledEventList, the items in the 
     *   first list are first shown in order.
     */</span>
    [
        '&lt;q&gt;I\'m new around here,&lt;/q&gt; you say.\b 
        &lt;q&gt;That probably explains why we haven\'t met before,&lt;/q&gt; he remarks. '
    ]
    
    <span class='comment'>/*  
     *   After the items in the first list have been shown, the items in the 
     *   second list are displayed in shuffled-random order. We don't need to
     *   define both lists; if we only define one, it will be used as a 
     *   shuffled list.
     */</span>    
    [
        '{The bob/he} listens politely while you tell him a chunk of you
        life-history. ',
        
        '{The bob/he} does his best to pretend he finds you as fascinating a
        topic of conversation as you appear to. ',
        
        '&lt;q&gt;How interesting!&lt;/q&gt; he mutters. '
    ]
    
    <span class='comment'>/* The name for the list of suggested topics */</span>
    name = 'yourself'
;

<span class='comment'>/*  
 *   Another ASK TOPIC
 *
 *   This time we mix it in with a StopEventList, which will display each 
 *   item in turn and then keep displaying the last one.
 *
 *   The @bob means the bob object, of course, but while we're talking to bob
 *   this can be referred to as 'himself', so this topic will match ASK BOB 
 *   ABOUT HIMSELF.
 */</span>
++ AskTopic, SuggestedAskTopic, StopEventList @bob
    [
        <span class='comment'>/* 
         *   We can't include a double-quoted string in an EventList, but we 
         *   can include a function pointer, which is what wrapping a 
         *   double-quoted string in the {: } short-form anonymous function 
         *   notation actually does. This enables us to invoke 
         *   bob.makeProper() using the &lt;&lt;&gt;&gt; syntax; bob.makeProper() 
         *   returns 'Bob', so this is what it displays, but it also carries 
         *   out the corresponding changes on the bob object.
         *
         *   An alternative would have been to write:
         *
         *   '&lt;q&gt;By the way, I don\'t think I caught your name,&lt;/q&gt; you 
         *   say.\b &lt;q&gt;I\'m '+ bob.makeProper() + ',&lt;/q&gt; he tells you. '
         */</span>        
        {: &quot;&lt;q&gt;By the way, I don't think I caught your name,&lt;/q&gt; you say.\b
            &lt;q&gt;I'm &lt;&lt;bob.makeProper()&gt;&gt;,&lt;/q&gt; he tells you. &quot; },
        
        '&lt;q&gt;Have you worked here long?&lt;/q&gt; you ask.\b
        &lt;q&gt;Only the last forty years,&lt;/q&gt; he replies. ',
        
        'You can\'t think of anything to ask him about himself right now. '
    ]    
    name = 'himself'
    
    <span class='comment'>/* 
     *   Once the player has seen the first two responses, the response to 
     *   ASK BOB ABOUT HIMSELF ceases to be interesting, so there's no point 
     *   in suggesting it any longer. So we'll only suggest it twice (note 
     *   that the default value of timesToSuggest is 1).
     */</span>
    timesToSuggest = 2
    
    <span class='comment'>/*
     *   Normally ASK BOB ABOUT WHATEVER would trigger the greeting protocols
     *   (the HelloTopic) when Bob is in his ConversationReadyState. But the
     *   final response suggests that no conversational exchange actually 
     *   takes place, so it would be inappropriate to display a greeting 
     *   only to have a message say that you can't think of anything to ask. 
     *   We can avoid this by marking this TopicEntry as non-conversational 
     *   once the final response is reached. Since we've already defined 
     *   timesToSuggest = 2 this is equivalent to marking it as 
     *   non-conversational once curiosity has been satisfied.
     */</span>    
    isConversational = (!curiositySatisfied)
    
;

<span class='comment'>/*  
 *   ASK TELL SHOW TOPIC
 *
 *   An AskTellShowTopic responds to ASK ABOUT, TELL ABOUT and SHOW 
 *   commands, so that this one will respond to ASK BOB ABOUT BLONDE, TELL 
 *   BOB ABOUT BLONDE, or SHOW BLONDE TO BOB.
 */</span>
++ AskTellShowTopic, SuggestedAskTopic, StopEventList @sally
    [
        {: &quot;&lt;q&gt;Who's that blonde woman over there?&lt;/q&gt; you ask.\b
            &lt;q&gt;That's &lt;&lt;sally.makeProper()&gt;&gt;, sir,&lt;/q&gt; he replies. &quot;
        },
        
        '&lt;q&gt;Is {the sally/she} a regular customer here?&lt;/q&gt; you enquire.\b
        &lt;q&gt;Oh yes, sir, one of my best,&lt;/q&gt; he tells you. ',
        
        'You\'ve asked enough about {the sally/her} for now; you don\'t want to
        give {the bob/him} the impression that you\'re fixated on her! '
    ]
    
    <span class='comment'>/* 
     *   We want this topic to be suggested as 'ask Bob about the blonde 
     *   woman' before we learn Sally's name and 'ask Bob about Sally' 
     *   thereafter.
     */</span>
    name = (sally.theName)
    
    <span class='comment'>/*   
     *   The first question presupposes that Sally is present to be asked 
     *   about, so we make this TopicEntry active only when Sally is in the 
     *   shop.
     */</span>    
    isActive = (sally.isIn(shop))
    timesToSuggest = 2
    isConversational = (!curiositySatisfied)
;

++ AskTopic, SuggestedAskTopic, StopEventList @tTown
    [
        <span class='comment'>/* 
         *   Until the player sees this response, the player character 
         *   hasn't even heard of the troubles. The tag &lt;.reveal troubles&gt; 
         *   notes the fact that the topic of troubles has now been 
         *   mentioned. Note that 'troubles' is an arbitrary string here; we 
         *   could have used &lt;.reveal xp1-q34r&gt;, except it wouldn't have 
         *   been so meaningul. Had we for example wanted to distinguish Bob 
         *   mentioning the troubles from Sally mentioning the troubles, we 
         *   could use &lt;.reveal bob-troubles&gt; and &lt;.reveal sally-troubles&gt;.
         */</span>        
        '&lt;q&gt;What\'s this town like?&lt;/q&gt; you ask.\b
            &lt;q&gt;Oh great. Just great,&lt;/q&gt; he replies. Lowering his voice he adds,
            &lt;q&gt;now that the troubles are over.&lt;/q&gt;&lt;.reveal troubles&gt; ',
                
        'He provides you with a whole lot of information about places to eat,
        shop, visit, and avoid throughout the turn. You don\'t take a tenth of
        it in. '
    ]
    name = 'the town'
;

<span class='comment'>/*  
 *   ASK TELL TOPIC
 *
 *   Since this is an AskTellTopic it will be used as a response to both ASK 
 *   BOB ABOUT TROUBLES and TELL BOB ABOUT TROUBLES.
 */</span>
++ AskTellTopic, SuggestedAskTopic, StopEventList @tTroubles
    [
        <span class='comment'>/*  
         *   The first response to ASK ABOUT TROUBLES mentions the 
         *   lighthouse, so once the player has seen this response, the PC 
         *   knows about the lighthouse. We can mark this by using 
         *   gSetKnown(lighthouse). Note that since it's convenient to use 
         *   the &lt;&lt;&gt;&gt; notation within a double-quoted string to do this, we 
         *   once again use the {: } short-form anonymous function to wrap 
         *   the double-quoted string in the EventList.
         */</span>        
        {: &quot;&lt;q&gt;You said something about some troubles,&lt;/q&gt; you remark, &lt;q&gt;what
            were they all about?&lt;/q&gt;\b
            &lt;q&gt;Well,&lt;/q&gt; he begins, &lt;q&gt;it all began up at the lighthouse...&lt;/q&gt;
            he breaks off, shaking his head, &lt;q&gt;No, you really don't want to
            know, you really don't -- believe me!&lt;/q&gt; &lt;&lt;gSetKnown(lighthouse)&gt;&gt;&quot;
        },
        
        '{The bob/he} steadfastly refuses to tell you anything more about the
        troubles. '
    ]
    
    <span class='comment'>/* 
     *   Here we test whether the tag 'troubles' has been revealed in order 
     *   to decide whether this TopicEntry is active.
     *
     *   tTroubles is a Topic, not a Thing (see below), so it starts out 
     *   known by default. As an alternative to using &lt;.reveal troubles&gt; and 
     *   testing for gRevealed('troubles') here we could have overridden 
     *   isKnown to nil on tTroubles and then used gSetKnown(tTroubles) to 
     *   make it known once Bob mentioned the troubles. 
     */</span>
    isActive = gRevealed('troubles')
    name = 'the troubles'
;

<span class='comment'>/*   
 *   Note that tWeather is another Topic (defined below) not a Thing. Using a
 *   lower case initial t to distinguish Topics from Things in this way is 
 *   just a convention I employ, not a requirement; but it's useful to adopt 
 *   some such convetion.
 */</span>
++ AskTellTopic, SuggestedAskTopic @tWeather
    &quot;&lt;q&gt;Nice weather we're having,&lt;/q&gt; you remark.\b
    &lt;q&gt;Not bad for the time of year, sir,&lt;/q&gt; he agrees. &quot;    
    name = 'the weather'
;

<span class='comment'>/*   
 *   ASK FOR TOPIC
 *
 *   We use an AskForTopic to handle commands like ASK BOB FOR SOMETHING. 
 *   Since Bob is desribed as stacking cans we'll allow the PC to ask for a 
 *   can; but since it's irrelevant to the plot, we shan't suggest it. 
 */</span>
++ AskForTopic @cans
    topicResponse()
    {
        &quot;&lt;q&gt;Can I have one of those cans please?&lt;/q&gt; you ask.\b
        &lt;q&gt;Sure,&lt;/q&gt; he replies. He turns round, picks up a can, and then
        turns back and hands it to you. &lt;q&gt;Here you are,&lt;/q&gt; he announces. &quot;;
        
        <span class='comment'>/*  Create a new Can object and then move it to the PC's inventory. */</span>
        local obj = new Can;
        obj.moveInto(me);
    }
;

<span class='comment'>/*   
 *   ALT TOPIC
 *
 *   We use an AltTopic to provide an alternative response to a 
 *   conversational command when a particular condition (defined in the 
 *   isActive property) holds. We can have as many AltTopics as we like; the 
 *   one that will be used is the last one for which isActive is true.
 *
 *   Here we use AltTopic to put a limit on the number of cans the PC can ask
 *   for, since we don't want the game to generate an infinite number of 
 *   dynamically-created cans. Ten cans should be more than enough, so we'll 
 *   stop when 10 cans have been created.
 */</span>
+++ AltTopic
    &quot;You've had more than enough cans for now. &quot;
    isConversational = nil
    isActive = Can.cansCreated &gt;= 10
;

<span class='comment'>/*   
 *   ASK TELL GIVE SHOW TOPIC
 *
 *   An AskTellGiveShowTopic provides the same response to ASK BOB ABOUT X, 
 *   TELL BOB ABOUT X, SHOW X TO BOB and GIVE X TO BOB. Here we'll use it for
 *   asking about, telling about, showing or giving cans.
 *
 *   There's one complication, though; the PC can only give Bob a can if the 
 *   PC is holding a can, and since the Can objects given to the player are 
 *   created dynamically, we don't have an object name for any such can. We 
 *   can instead test for an object of kind Can, but a TopicEntry doesn't 
 *   allow us to do that as standard, (hopefully that's something that will 
 *   be changed in some future version of TADS 3.
 *
 *   If it were allowed, we'd simply express the matchObj for this 
 *   TopicEntry as a list:
 */</span>
++ AskTellGiveShowTopic [cans, Can]
    
    <span class='comment'>/* 
     *   Since the standard library can't handle a class as a matchObj, we 
     *   need to override the matchTopic() method.
     */</span>
    matchTopic(fromActor, topic)
    {
        <span class='comment'>/* 
         *   Since we know that we've defined matchObj as a list, we know we 
         *   can treat it as a collection, which simplifies what we need to 
         *   put here.
         */</span>
        if (matchObj.indexWhich({x: findMatchObj(x, topic)}) != nil)
                    return matchScore;


        <span class='comment'>/* didn't find a match - indicate this by returning a nil score */</span>
        return nil;
    }
    
    <span class='comment'>/*  
     *   We also need to override findMatchObj() so that it can handle both a
     *   Thing (if the player typed GIVE or SHOW) or a ResolvedTopic, and 
     *   can cope with classes as well as individual objects
     */</span>
    
    findMatchObj(obj, rt)
    {
        if(rt.ofKind(obj))
            return true;
        
        if(!rt.ofKind(ResolvedTopic))
            return nil;
        
        <span class='comment'>/* check the &quot;in scope&quot; list */</span>
        if (rt.inScopeList.indexWhich({x: x.ofKind(obj)}) != nil)
            return true;

        <span class='comment'>/* check the &quot;likely&quot; list */</span>
        return (rt.likelyList.indexOf({x: x.ofKind(obj)}) != nil);
    }

    topicResponse = &quot;&lt;q&gt;What's in those cans?&lt;/q&gt; you ask.\b
        &lt;q&gt;Baked beans,&lt;/q&gt; he replies briskly, &lt;q&gt;not just any baked beans,
        though -- the beans in those cans are environmentally-friendly
        anti-carcogenic organic high-fibre baked beans -- the very best!&lt;/q&gt; &quot;
;

<span class='comment'>/*  
 *   DEFAULT ASK TOPIC
 *
 *   The chances are the player will try to ASK Bob about topics for which we
 *   haven't replied a response. We can use a DefaultAskTopic to deal with 
 *   these commands. To avoid making the NPC look like a talking robot, it's 
 *   best to vary such responses, so we also make the DefaultAskTopic a 
 *   ShuffledEventList.
 */</span>

++ DefaultAskTopic, ShuffledEventList
    [
        '{The bob/he} gives a puzzled frown, as if he didn\'t understand your
        question. ',
        
        '&lt;q&gt;Yes, well,&lt;/q&gt; he begins, and then gabbles such a rapid reply that
        you don\'t catch a word of it. ',
        
        '&lt;q&gt;The way I see it...&lt;/q&gt; he begins; but then the rest of his reply
        is lost in a fit of coughing. '
    ]
;

<span class='comment'>/*   
 *   DEFAULT TELL TOPIC 
 *
 *   We use DefaultTellTopic to cater for topics we haven't provided a 
 *   specific TELL ABOUT response to.
 */</span>
++ DefaultTellTopic
    &quot;{The bob/he} listens politely as you rattle on. &quot;
;

<span class='comment'>/*  
 *   COMMAND TOPIC
 *
 *   We can use a CommandTopic to provide a response to an order directed to 
 *   an NPC, such as BOB, GO WEST.
 *
 *   A SystemAction is normally an out-of-game command that can only 
 *   meaningfully be addressed to the parser, such as SAVE, RESTORE, RESTART,
 *   QUIT or UNDO; so we can use a CommandTopic to trap attempts to address 
 *   such commands to an actor and provide a suitable (here suitably 
 *   flippant) response. 
 */</span>
++ CommandTopic @SystemAction
    &quot;&lt;q&gt;Well,&lt;/q&gt; he replies, &lt;q&gt;If you ask me that's the sort of command you
    should be addressing to the parser, not to an NPC in the game!&lt;/q&gt; &quot;
;

<span class='comment'>/*  
 *   We can also use a CommandTopic to provide a response to particular 
 *   commands such as BOB, JUMP (as here).
 *
 *   CommandTopic doesn't make it particularly easy to match command 
 *   involving particular objects, such as BOB, TAKE THE RED BALL or BOB, 
 *   PUT THE RED BALL IN THE GREEN BOX; to match such commands you'd need to 
 *   override the matchTopic() method of the CommandTopic. Alternatively you 
 *   could just download and use the TCommand extension.
 */</span>

++ CommandTopic @JumpAction
    &quot;&lt;q&gt;Jump!&lt;/q&gt; you cry!\b
    {The bob/he} is so startled that he jumps. &quot;
;

<span class='comment'>/*  
 *   DEFAULT COMMAND TOPIC
 *
 *   We use a DefaultCommandTopic to handle all orders given to the Bob for 
 *   which we haven't provided a customised response.
 */</span>
++ DefaultCommandTopic
    &quot;&lt;q&gt;Not wishing to be rude, sir, but I don't reckon you have any call to be
    bossing me around,&lt;/q&gt; he complains. &quot;
;
     
++ DefaultAskForTopic
    &quot;&lt;q&gt;I'm afraid I don't think I can help you there, sir,&lt;/q&gt; he replies. &quot;
;

//==============================================================================
<span class='comment'>/*  
 *   CODE FOR THE SALLY NPC 
 *
 *   Sally is a more complex NPC than Bob, in that she'll lead the PC to the 
 *   lighthouse and then follow him around. We also use her to illustrate 
 *   ConvNodes and AgendaItems. 
 *
 *   To begin with a summary: Sally starts out in the shop looking for 
 *   clothes, but can't be talked to while she's in that state. As soon as 
 *   she hears Bob mention the troubles she goes outside the shop to wait 
 *   for the PC. When the PC emerges from the shop she offers to take him to 
 *   the lighthouse. If he refuses, the game ends then and there. If he 
 *   accepts she leads him to the lighthouse (she acts as 'TourGuide' so he 
 *   can follow her). Once they arrive at the lighthouse she will follow the 
 *   PC (there's no particular reason for this swap of leading character 
 *   other than to demonstrate the two different ways in which an NPC can be 
 *   made to accompany the PC). Once they start to explore the lighthouse 
 *   together they come face to face with the origin of the troubles.
 *
 *   TOUR GUIDE
 *
 *   We make Sally a TourGuide so that the PC can follow her during the 
 *   appropriate segment of the game.
 */</span>

sally: TourGuide, Person 'petite blonde pretty woman*people' 
    'blonde woman' @shop
    &quot;She's a petite blonde, with a pretty round face. &quot;
    
    properName = 'Sally'
    isHer = true
    globalParamName = 'sally'
    
    uselessToAttackMsg = 'You are not the sort of man that goes round attacking
        defenceless women. '
    
    cannotKissActorMsg = ('You\'d better not; ' + (gRevealed('married') ?
                             'you\'ve already told her you\'re married. ' : 'you
                                 don\'t know her well enough. '))
;

<span class='comment'>/*  
 *   We add an Unthing to Sally as we did for Bob, to handle attempts to 
 *   refer to Sally before the PC has learned her name.
 */</span>
+ Unthing 'sally' 'Sally'
    'You don\'t know anyone called Sally yet. '
;

<span class='comment'>/*  
 *   HERMIT ACTOR STATE
 *
 *   A HermitActorState is an ActorState in which an NPC will not respond to 
 *   any conversational commands. It can be used to represent an NPC who is 
 *   preoccupied, stand-offish, unconscious, or even dead. Here we start 
 *   Sally off in a HermitActorState since we don't want the PC to talk to 
 *   her until they meet outside the shop. While he's in the shop the PC 
 *   should concentrate on talking to Bob.
 *
 *   If we mix in an EventList class with an ActorState, the EventList's 
 *   doScript() method will be called every tutn the NPC is in the state, so 
 *   that we can display a list of messages indicating that that NPC is 
 *   actually doing something. Here we make the HermitActorState also a 
 *   ShuffledEventList so that Sally looks a bit livelier than a tailor's 
 *   dummy while she's shopping for clothes. 
 */</span>

+ sallyShopping: HermitActorState, ShuffledEventList
    <span class='comment'>/* This is the state Sally starts out in. */</span>
    isInitState = true
    
    specialDesc = &quot;{The sally/she} is standing by the clothes rack, carefully
        inspecting everything that's on offer. &quot;
    
    stateDesc = &quot;She's standing by the clothes rack, inspecting what\'s on
        offer. &quot;
    
    <span class='comment'>/* 
     *   The message to display when we address a conversational command to 
     *   an actor in this state.
     */</span>
    noResponse = &quot;You know better than to interrupt a woman when she's
        hunting for bargains on the clothes rack. &quot;
    
    <span class='comment'>/*   
     *   The list of random messages to display while the actor is in this 
     *   state.
     */</span>
    eventList = [
        '{The sally/she} takes a coat from the rack, holds it against her body,
        then shakes her head and returns it to the rack. ',
        
        '{The sally/she} continues rifling through the rack. ',
        
        '{The sally/she} picks up a hat and tries it on. She pulls it down over
        her face, frowns, and then puts it back. ',
        
        {: &quot;{The sally/she} takes a &lt;&lt;rand('skirt', 'blouse', 'dress',
                                           'jumper')&gt;&gt; off the rack and mutters
            something disapproving about the wrong shade of &lt;&lt;rand('blue',
                'green', 'yellow', 'orange', 'pink', 'mauve')&gt;&gt;. &quot;
        },
        
        '{The sally/she} struggles to remove a pair of trousers from the rack,
        then decides that they\'re too long, so struggles to put them back
        again. '
    ]
    
    <span class='comment'>/* 
     *   It would be intrusive to see these messages every turn, so we'll 
     *   start off displaying them on average on two turns out of three.
     */</span>
    eventPercent = 67
    <span class='comment'>/*   
     *   Once the player has seen all these messages once, it's probably 
     *   best to make them less frequent before they start to seem obviously 
     *   repetitive and tiresome, so we'll reduce the frequency to one turn 
     *   in three once after displaying five messages.
     */</span>
    eventReduceTo = 33
    eventReduceAfter = 5
    
    <span class='comment'>/*   
     *   When Sally leaves the shop the default message would be &quot;Sally/The 
     *   blonde woman leaves to the north.&quot; We replace that here with 
     *   something more appopriate to the context.
     */</span>
    sayDepartingDir(dir, conn)
    {
        &quot;Then she turns away again and hurries out of the shop. &quot;;
    }
;

<span class='comment'>/*  
 *   ACTOR STATE
 *
 *   So far we've used various subclasses of ActorState, but sometimes it 
 *   can be useful to use ActorState itself when we don't need any of the 
 *   specializations the subclasses provide, as here when the ActorStatre is 
 *   used simply while Sally is waiting outside the shop.
 */</span>
+ sallyStreetState: ActorState
    specialDesc = &quot;{The sally/she} is standing just outside the shop. &quot;
;

<span class='comment'>/*  
 *   GUIDED TOUR STATE
 *
 *   As soon as the PC emerges from the shop Sally will offer to take him to 
 *   the lighthouse. A GuidedTourState allows us to set up a mechanism 
 *   whereby the PC can follow the NPC. We need to define a series of 
 *   GuidedTourStates, each one representing one step of the journey.
 */</span>

+ sallyTour1State: GuidedTourState
    commonDesc = 'waiting for you to follow her down the street to the east'
    stateDesc = &quot;She\'s &lt;&lt;commonDesc&gt;&gt;. &quot;
    specialDesc = &quot;{The sally/she} is &lt;&lt;commonDesc&gt;&gt;. &quot;
    
    <span class='comment'>/* 
     *   The next state Sally will go to once the PC has followed her for one
     *   step in this state.
     */</span>
    stateAfterEscort = sallyTour2State
    
    <span class='comment'>/*   The TravelConnector through which Sally wants to lead the PC */</span>
    escortDest = street.east
    
    <span class='comment'>/*   
     *   The GuidedInTravelState to use when the PC follows Sally. Sally will
     *   switch to this state temporarily while travel is in progress, and 
     *   it will be used to describe Sally's part in the travel (e.g. &quot;Sally 
     *   leads the way&quot;). The library provides a perfectly acceptable 
     *   plain-vanilla default, but better results can be obtained by 
     *   customising it, so we'll provide our own class (defined below).
     */</span>
    escortStateClass = SallyEscortState
;

+ sallyTour2State: GuidedTourState
    commonDesc = 'waiting for you to follow her south across the field'
    stateDesc = &quot;She\'s &lt;&lt;commonDesc&gt;&gt;. &quot;
    specialDesc = &quot;{The sally/she} is &lt;&lt;commonDesc&gt;&gt;. &quot;
    stateAfterEscort = sallyTour3State
    escortDest = road.south
    
    <span class='comment'>/* 
     *   The mesage that's displayed when we've just completed the travel 
     *   that brought us to this point. If the PC follows Sally while she's 
     *   in SallyTour1State (the previous GuidedTourState), this is the 
     *   message that will be shown when Sally and the PC arrive at the 
     *   destination of that first step of the travel.
     */</span>
    arrivingWithDesc = &quot;{The sally/she} comes to a halt on the roadside and
        points southwards across the open field. &lt;q&gt;We'll go that way,&lt;/q&gt;
        she says, &lt;q&gt;It's twice as far by road.&lt;/q&gt; &quot;
    escortStateClass = SallyEscortState
    
    
    <span class='comment'>/*  
     *   By default nothing compels the PC to follow the NPC when she's in a 
     *   GuidedTourState; the PC can wander off in any direction he likes, 
     *   and the NPC will be left patiently waiting for him to return to 
     *   her. But if we like we can make the NPC prevent the PC from going 
     *   off in any direction other than the one she wants him to go by 
     *   having her block attempts to go anywhere else. The best place to do 
     *   that is in beforeTravel().
     */</span>
    beforeTravel(traveler, connector)
    {
        if(connector == road.east)
        {
            &quot;&lt;q&gt;No, it's three times the distance that way!&lt;/q&gt; she stops you, 
            &lt;q&gt;we should take the short cut across the field -- it's much
            quicker!&lt;/q&gt;&quot;;
            exit;
        }
        if(connector == road.west)
        {
            &quot;&lt;q&gt;You can't be giving up on me already!&lt;/q&gt; she protests, &lt;q&gt;It's
            &lt;i&gt;that&lt;/i&gt; way,&lt;/q&gt; she adds, pointing firmly south across the
            field. &quot;;
            exit;
        }
        
        <span class='comment'>/* 
         *   We must call the inherited handling here, or the whole 
         *   GuidedTour mechanism will be broken.
         */</span>
        inherited(traveler, connector);
    }
;

+ sallyTour3State: GuidedTourState
    commonDesc = 'waiting for you to follow her down the hill to the southeast'
    stateDesc = &quot;She\'s &lt;&lt;commonDesc&gt;&gt;. &quot;
    specialDesc = &quot;{The sally/she} is &lt;&lt;commonDesc&gt;&gt;. &quot;
    stateAfterEscort = sallyArriving
    escortDest = hillTop.southeast
    escortStateClass = SallyEscortState
    arrivingWithDesc = &quot;As you arrive at the top of the hill {the sally/she}
        pauses and points down to the southeast. &lt;q&gt;That way,&lt;/q&gt; she announces.
        &quot;
;

<span class='comment'>/*   
 *   GUIDED IN TRAVEL STATE 
 *
 *   The GuidedInTravelState is the complement to the GuidedTourState. It's 
 *   used every time the NPC actually leads the PC on a step of the way, the 
 *   main purpose being to display a message describing the NPC leading the 
 *   PC.
 */</span>
class SallyEscortState: GuidedInTravelState
    <span class='comment'>/* 
     *   It's the sayDeparting() method that actually displays the message 
     *   describing the NPC leading the PC.
     */</span>
    sayDeparting(conn)
    {
        <span class='comment'>/* 
         *   This is where we use the custom followDesc property we defined 
         *   when setting up the map. If the connector through which Sally 
         *   and the PC are travelling defines the followDesc property, we 
         *   use it to construct the message describing the travel. 
         *   Otherwise we use the plain-vanilla message inherited from the 
         *   standard library. Customising the message on a per-connector 
         *   basis like this makes the output read quite a lot better.
         */</span>
        if(conn.propDefined(&amp;followDesc))
            &quot;{The sally/she} leads the way &lt;&lt;conn.followDesc&gt;&gt;. &quot;;
        else
            inherited(conn);
    }
;

<span class='comment'>/*   
 *   ACTOR STATE
 *
 *   Sally will leave this ActorState almost as soon as she enters it. It's 
 *   purpose is to smooth the transition from Sally leading the PC to Sally 
 *   following the PC.
 */</span>

+ sallyArriving: ActorState
    arrivingTurn()    
    {
        <span class='comment'>/* 
         *   As soon as the PC and Sally arrive together at the lighthouse, 
         *   we switch her to the sallyFollowing state (in which she will 
         *   follow the PC wherever he leads) and make her initiate a 
         *   conversation using the 'lighthouse' Conversation Node (for 
         *   which see below). The following statement achieves both of 
         *   these things at once.
         */</span>
        sally.initiateConversation(sallyFollowing, 'lighthouse');
    }
    <span class='comment'>/*  
     *   The message to display indicating that Sally has stopped acting as 
     *   lead actor.
     */</span>
    arrivingWithDesc = &quot;{The sally/she} comes to a stop outside the old
        lighthouse and turns to face you. &quot;
;

<span class='comment'>/*  
 *   ACCOMPANYING STATE
 *
 *   An Actor in an AccompanyingState will follow the PC around for as long 
 *   as she's in that state (although that behaviour can be overridden to 
 *   prevent the NPC from following the PC through certain connectors if 
 *   desired. Once she enters this state, Sally will remain in it for the 
 *   rest of the game. 
 */</span>

+ sallyFollowing: AccompanyingState
    specialDesc = &quot;{The sally/she} is at your side. &quot;
    
    <span class='comment'>/* 
     *   The arrivingTurn() method is called each time the NPC arrives in a 
     *   at a location while following the PC. Here we use it to make Sally 
     *   say or do something via an InitiateTopic keyed on the location just 
     *   arrived at; calling sally.initiateTopic(obj) will cause the 
     *   corresponding InitiateTopic @obj to be triggered.
     */</span>
    arrivingTurn()
    {
        sally.initiateTopic(sally.location);
    }
    
    <span class='comment'>/*  
     *   Normally an NPC will follow the PC anywhere, but we can change that 
     *   by overriding accompanyTravel(). Here we'll stop Sally following 
     *   the PC back into town. This doesn't stop the PC returning to the 
     *   town; Sally simply won't follow him there. If we wanted to prevent 
     *   the PC returning to the town as well while Sally's following for 
     *   him we could also do that in this method, by checking for 
     *   conn==road.west and then displaying a message and using the exit 
     *   macro to prevent travel, e.g.
     *
     *.  accompanyTravel(traveler, conn)
     *.  {
     *.    if(conn == road.west)
     *.    {
     *.       &quot;&lt;q&gt;Let's not go that way,&lt;/q&gt; {the sally/she} urges. &quot;;
     *.        exit;
     *.    }
     *.    return true;
     *.  }
     *
     */</span>
    accompanyTravel(traveler, conn) 
    { 
        return conn != road.west; 
    }

    <span class='comment'>/*  
     *   Just as a GuidedTourState uses a GuidedInTravelState to describe the
     *   actual travel, so an AccompanyingState uses an associated 
     *   AccompanyingInTravelState. We override getAccompanyingTravelState 
     *   here to use a custom AccompanyingInTravelState.
     */</span>    
    getAccompanyingTravelState(traveler, connector)
    {
        <span class='comment'>/* 
         *   Create the default intermediate state for the travel.  Note
         *   that the lead actor is the actor performing the command - this
         *   won't necessarily be the traveler, since the actor could be
         *   steering a vehicle.  
         */</span>
        return new SallyAccompanyingInTravelState(
            getActor(), gActor, getActor().curState);
    }
;

<span class='comment'>/*   
 *   ACCOMPANYING IN TRAVEL STATE 
 *
 *   While the library provides a perfectly acceptable plain-vanilla message 
 *   to describe an NPC following the PC around (&quot;Sally comes with you&quot;) we 
 *   can get better results by using a custom AccompanyingInTravelState.
 */</span>  

class SallyAccompanyingInTravelState: AccompanyingInTravelState
    <span class='comment'>/* 
     *   Once again we define sayDeparting() so that it uses the followDesc 
     *   of the connector being traversed to construct a message specific to 
     *   that connector (such as &quot;Sally follows you through the door&quot;).
     */</span>
    sayDeparting(conn)
    {
        if(conn.propDefined(&amp;followDesc))
            &quot;{The sally/she} follows you &lt;&lt;conn.followDesc&gt;&gt;. &quot;;
        else
            inherited(conn);
    }
;

<span class='comment'>/*  
 *   INITIATE TOPIC
 *
 *   An InitiateTopic is triggered by an explicit call to 
 *   actor.initiateTopic. It's use to make an NPC react to specific things 
 *   in the game. These InitiateTopics are all triggered from the 
 *   arrivingTurn() method of sallyFollowing to make Sally respond to 
 *   arriving in various locations. Note that we're also locating all these 
 *   InitiateTopics in the sallyFollowingState (the definition of the 
 *   SallyAccompanyingInTravelState forms no part of the object containment 
 *   hierarchy).
 */</span>
++ InitiateTopic @lobby
    topicResponse()
    {
        &quot;&lt;q&gt;Well, this is it,&lt;/q&gt; {the sally/she} announces, &lt;q&gt;Let\'s take a
        look around.&lt;/q&gt; &quot;;
        
        <span class='comment'>/*  
         *   This is the way to add a DelayedAgendaItem (for which see 
         *   below) to Sally's agenda list.
         *
         */</span>
        sally.addToAgenda(sallyImpatientAgenda.setDelay(4));
        <span class='comment'>/* 
         *   We only want this InitiateTopic to fire on the first time Sally 
         *   enters the lobby. Setting isActive to nil here disables this 
         *   InitiateTopic for subsequent occasions.
         */</span>
        isActive = nil;
    }
;

++ InitiateTopic @midStair
    &quot;&lt;q&gt;That's it,&lt;/q&gt; {the sally/she} announces, pointing to the oak door,
    &lt;q&gt;the answer to all your questions lies through there. Enter if you
    dare!&lt;/q&gt; &quot;
;

++ InitiateTopic @horrorChamber
    topicResponse()
    {
        &quot;She lets out a piercing scream; but you're only dimly aware of
        her presence; as your stomach threatens to empty its contents, the room
        seems to start spinning around you, and then everything goes blank.\b&quot;;
        
        <span class='comment'>/*  
         *   We'll end the game at this point (it's only a demo, after all!).
         *   Note how we can use finishGameMsg to display a custom finishing
         *   message.
         */</span>
        finishGameMsg('YOU HAVE FAINTED', [finishOptionUndo]);
    }
;

++ InitiateTopic @road
    &quot;&lt;q&gt;I'm not going back into town until I've shown you what's in the
    lighthouse,&lt;/q&gt; {the sally/she} warns you. &quot;
;

++ InitiateTopic, StopEventList @store
    [
        '&lt;q&gt;They took everything out after the troubles,&lt;/q&gt; {the sally/she}
        remarks, &lt;q&gt;there\'s nothing interesting in this part of the lighthouse
        now.&lt;/q&gt; ',
        
        '&lt;q&gt;Like I said, there\'s nothing interesting left in this part of the
        lighthouse now,&lt;/q&gt; {the sally/she} remarks, &lt;q&gt;let\'s look somewhere
        else.&lt;/q&gt; '
    ]
;


++ InitiateTopic, StopEventList @office
    [
        '&lt;q&gt;There doesn\'t seem to be much here, does there?&lt;/q&gt;
        {the sally/she} declares. ',
        
        '{The sally/she} glances around the room without much interest. '
    ]
;

++ InitiateTopic @cliffPath
    &quot;&lt;q&gt;Well, there was a &lt;i&gt;lot&lt;/i&gt; of point in coming here, wasn\'t there!&lt;/q&gt;
    {the sally/she} declares. &quot;
;

<span class='comment'>/*   
 *   TOPIC GROUP
 *
 *   We'll define a few conversational responses for Sally; these could all 
 *   go directly in the sally object, but we can also use a TopicGroup for 
 *   the purpose (and since there are so many other kinds of thing going 
 *   directly in the actor, using a TopicGroup can seem neater).
 */</span>

+ TopicGroup
    <span class='comment'>/* 
     *   The TopicEntries in this TopicGroup will only be reachable when this
     *   isActive condition is true. As a matter of fact it will true 
     *   practically all the time the PC is in a position to talk to Sally in
     *   any case (since GuidedTourState is a subclass of 
     *   AccompanyingState), so we're just illustrating the principle here. 
     *   In a real game you might want to use a more restrictive condition.
     */</span>
    isActive = (sally.curState.ofKind(AccompanyingState))
;

++ AskTopic, SuggestedAskTopic, StopEventList @sally
    [
        '&lt;q&gt;Are you married, Sally?&lt;/q&gt; you ask.\b
        &lt;q&gt;I was,&lt;/q&gt; she tells you, &lt;q&gt;but then the troubles came. But how
        about you? Do you have a family?&lt;/q&gt;&lt;.convnode family&gt; ',
        
        '&lt;q&gt;How did the troubles...?&lt;/q&gt; you begin.\b
        &lt;q&gt;End my marriage?&lt;/q&gt; she asks, &lt;q&gt;Well, it\'s a long story. Maybe
        I\'ll tell you about it some other time.&lt;/q&gt; ',
        
        '&lt;q&gt;Is there a man in your life now?&lt;/q&gt; you ask.\b
        &lt;q&gt;I can but keep hoping,&lt;/q&gt; she smiles coyly. ',
        
        '&lt;q&gt;Tell me more about yourself, Sally,&lt;/q&gt; you say.\b
        &lt;q&gt;Some other time,&lt;/q&gt; she replies. '
    ]
    name = 'herself'
    timesToSuggest = 3
;

+++ AltTopic, SuggestedAskTopic
    &quot;&lt;q&gt;I'm sorry, I don't think we've been introduced,&lt;/q&gt; you say, &lt;q&gt;You
    are...?&lt;/q&gt;\b
    &lt;q&gt;I'm &lt;&lt;sally.makeProper()&gt;&gt;,&lt;/q&gt; she tells you, &lt;q&gt;I've lived round here
    most of my life.&lt;/q&gt;&quot;
    name = 'herself'
    isActive = !sally.isProperName
;

   <span class='comment'>/* 
    *   ASK TELL TOPIC
    *
    *   Note that as an alternative to using the @obj template syntax to 
    *   make a TopicEntry match the single object obj, we can provide a list 
    *   of objects that a TopicEntry can match. Here we make asking/telling 
    *   Sally about the lighthouse equivalent to asking/telling her about 
    *   the troubles (or about the oakDoor once the PC has seen it)
    */</span>
++ AskTellTopic, SuggestedAskTopic [lighthouse, tTroubles, oakDoor]
    &quot;&lt;q&gt;So what were the troubles, and what are we going to find at the
    lighthouse?&lt;/q&gt; you ask.\b
    &lt;q&gt;You'll see when we get there,&lt;/q&gt; she assures you. &quot;
    name = 'the lighthouse'
;

<span class='comment'>/*   
 *   ALT TOPIC
 *
 *   We also provide a whole series of AltTopics to tailor the response to 
 *   ASK/TELL SALLY ABOUT LIGHTHOUSE/TROUBLES according to the current 
 *   situation.
 */</span>
+++ AltTopic, SuggestedAskTopic
    &quot;&lt;q&gt;So, what did happen in the lighthouse?&lt;/q&gt; you ask, &lt;q&gt;is that where the
    troubles started?&lt;/q&gt;\b
    &lt;q&gt;The answers are all in the lighthouse,&lt;/q&gt; she tells you, &lt;q&gt;if you want
    to find out what happened, you'll have to go inside.&lt;/q&gt; &quot;
    name = 'the lighthouse'
    isActive = me.hasSeen(lighthouse)
;

+++ AltTopic, SuggestedAskTopic
    &quot;&lt;q&gt;So, what did happen here?&lt;/q&gt; you want to know, &lt;q&gt;And what were the
    troubles?&lt;/q&gt;\b
    &lt;q&gt;Keep looking,&lt;/q&gt; she tells you, &lt;q&gt;you'll see soon enough!&lt;/q&gt; &quot;
    name = 'the troubles'
    isActive = me.location is in (lobby, store, office)
;

+++ AltTopic, SuggestedAskTopic
    &quot;&lt;q&gt;What's on the other side of that door?&lt;/q&gt; you ask, &lt;q&gt;is that where
    the troubles started?&lt;/q&gt;\b
    &lt;q&gt;If you go through it you'll see,&lt;/q&gt; she tells you. &quot;    
    name = 'the troubles'
    isActive = me.isIn(midStair)
;

++ TellTopic, StopEventList @me
    [
        '&lt;q&gt;I\'m new to this area,&lt;/q&gt; you tell her.\n
        &lt;q&gt;So I gathered,&lt;/q&gt; she remarks. ',
        
        'You carry on telling her about yourself, but you sense she isn\'t
        really listening. '
    ]
;

++ CommandTopic @SystemAction
    &quot;&lt;q&gt;What a very curious request!&lt;/q&gt; she declares. &quot;
;

++ DefaultCommandTopic
    &quot;&lt;q&gt;My husband used to try telling me what to do all the time, too;&lt;/q&gt; she
    remarks, &lt;q&gt;frankly, it's not something I find attractive in a man.&lt;/q&gt; &quot;
;

<span class='comment'>/*   
 *   DEFAULT GIVE SHOW TOPIC
 *
 *   We can use a DefaultGiveShowTopic to provide a response to attempt to 
 *   Give or Show anything to Sally (for which we haven't provided any more 
 *   specific handling).
 */</span>

++ DefaultGiveShowTopic
    &quot;&lt;q&gt;Yes, {it\'s dobj/he\'s} {a dobj/he},&lt;/q&gt; she observes, &lt;q&gt;very
    interesting, I\'m sure!&lt;/q&gt; &quot;
;

<span class='comment'>/*   
 *   DEFAULT ANY TOPIC
 *
 *   A DefaultAnyTopic will match anything for which we haven't provided a 
 *   more specific response. Here, for example, it would match ASK SALLY 
 *   ABOUT HER MOTHER, or TELL SALLY ABOUT CHINESE COOKERY. A 
 *   DefaultAnyTopic is used as a last resort: any other kind of 
 *   DefaultXXXXTopic (e.g. DefaultAskTopic, DefaultTellTopic, 
 *   DefaultGiveShowTopic) will be used in preference to it (so our 
 *   DefaultGiveShowTopic will still work, but the DefaultAnyTopic would 
 *   have handled GIVE &amp; SHOW if we hadn't defined a DefaultGiveShowTopic.
 *
 *   Here we use a DefaultAnyTopic in place of defining separate a 
 *   DefaultAskTopic and DefaultTellTopic (given that most other kinds have 
 *   already been covered). We could have done almost the same job in this 
 *   particular context with a DefaultAskTellTopic.
 */</span>

++ DefaultAnyTopic
    &quot;&lt;q&gt;We can talk later; let's just get to the lighthouse,&lt;/q&gt; she replies. &quot;
;

<span class='comment'>/*   
 *   ALT TOPIC
 *
 *   We can use AltTopics with DefaultTopics as well as other kinds of 
 *   TopicEntry. Normally one would use a ShuffledEventList to vary the 
 *   response to a DefaultTopic, but here we'll use a whole series of 
 *   AltTopics to vary the response according to the situation.
 */</span>
+++ AltTopic
    &quot;&lt;q&gt;Let\'s talk about that some other time,&lt;/q&gt; she suggests, &lt;q&gt;I think we
    should go back to the lighthouse before it gets dark.&lt;/q&gt; &quot;
    isActive = me.hasSeen(lighthouse) &amp;&amp; !me.canSee(lighthouse)
;

+++ AltTopic
    &quot;&lt;q&gt;All this talk!&lt;/q&gt; she complains, &lt;q&gt;anyone would think you were afraid
    to go in there!&lt;/q&gt; She nods towards the lighthouse. &quot;
    isActive = me.isIn(cliff)
;

+++ AltTopic, ShuffledEventList
    [
        '&lt;q&gt;This doesn\'t seem the right place to talk about that,&lt;/q&gt; she
        replies, &lt;q&gt;I thought you were anxious to find out about the
        troubles!&lt;/q&gt; ',
        
        '&lt;q&gt;Later,&lt;/q&gt; she urges you, &lt;q&gt;in any case, you\'ll see everything
        differently once you\'ve seen the source of the troubles.&lt;/q&gt; ',
        
        '&lt;q&gt;We can discuss that some other time,&lt;/q&gt; she tells you, &lt;q&gt;right
        now, let\'s concentrate on what we came for!&lt;/q&gt; '
    ]
    isActive = me.location is in (lobby, store, office, midStair)
;


//------------------------------------------------------------------------------
<span class='comment'>/*   
 *   CONVERSATION NODES
 *
 *   A Conversation Node, or ConvNode (as the class is actually called) 
 *   represents a particular point in a conversation at which a particular 
 *   set of responses becomes appropriate. For example, if an NPC asks a 
 *   question, it may be pertinent to reply YES or NO immediately after, 
 *   whereas interjecting YES or NO into the conversation at some later or 
 *   earlier point of the conversation would either be meaningless, or else 
 *   would have some quite different meaning. 
 *
 *
 *   There are basically two types of Conversation Node that one might 
 *   typically be implemented in TADS 3, which one might for convenience 
 *   called 'open' and 'closed' (though this is nowhere defined in the 
 *   library's nomenclature). An 'open' node is one at which a particular 
 *   set of responses becomes appropriate (such as YES or NO or some more 
 *   detailed reply), but the player doesn't have to use one of them; the 
 *   player can take the opportunity to use one of these responses or ignore 
 *   it (though once ignored, the opportunity is lost, as it would be in a 
 *   real conversation).
 *
 *   A 'closed' node, on the other hand, is where the NPC demands an answer 
 *   and won't let the conversation move on until s/he receives one. This is 
 *   the more laborious kind of Conversation Node to implement, but it's the 
 *   one we'll illustrate first, as it demonstrates more of the features of 
 *   ConvNodes, and once we've implemented a 'closed' node the 'open' ones 
 *   will seem easy!
 *
 *   The ConvNode below is used for Sally to offer to show the PC to the 
 *   lighthouse; she'll demand that he says yes or no.
 */</span>

+ ConvNode 'troubles'
    <span class='comment'>/* 
     *   The message to display when this ConvNode is activated through a 
     *   call to initiateConversation(). The message should be used for the 
     *   NPC to ask the question (or make the statement) demanding an answer 
     *   from among the options available in this ConvNode.
     *
     *   If this ConvNode was going to be used several times we might want to
     *   vary the message displayed here, in which case we could use 
     *   npcGreetingList instead of npcGreetingMsg, but we'll only ever enter
     *   this ConvNode once, so npcGreetingMsg will so just fine.
     */</span>
    npcGreetingMsg = &quot;{The sally/she} walks up to you and says, &lt;q&gt;Excuse me,
        but I couldn't help hearing you asking about the troubles. Would you
        like me to show you the lighthouse?&lt;/q&gt; &quot;
    
    <span class='comment'>/*
     *   A set of messages to display in which the NPC reminds the PC that 
     *   she's waiting for an answer if he hasn't spoken to her on that 
     *   turn. If we were content to use the same message each time we could 
     *   use npcContinueMsg instead, but as that could make Sally seem rather
     *   robotic it's better to vary her nags with a ShuffledEventList on 
     *   npcContinueList instead.
     */</span>    
    npcContinueList: ShuffledEventList
    {
        [
            '&lt;q&gt;The lighthouse,&lt;/q&gt; {the sally/she} reminds you, &lt;q&gt;I offered
            to take you to see it. Would you like me to?&lt;/q&gt; ',
            
            '&lt;q&gt;I\'m still waiting to hear if you\'d me to show you the
            lighthouse,&lt;/q&gt; {the sally/she} reminds you. ',
            
            '&lt;q&gt;I\'ve been kind enough to offer to show you the lighthouse, so
            I think I deserve an answer,&lt;/q&gt; {the sally/she} remarks, &lt;q&gt;So --
            are you coming?&lt;/q&gt; '
        ]
        <span class='comment'>/*  
         *   Sally would seem needlessly importunate if she nagged the PC 
         *   for a response on every turn he didn't say something, so we'll 
         *   use one of these messages on average only every other turn. 
         */</span>
        eventPercent = 50
    }
    
    <span class='comment'>/*  
     *   Since Sally is insisting on an answer, we need to block the various 
     *   ways in which the player could simply end the conversation. Walking 
     *   away from her might be one way; saying goodbye would be another. We 
     *   use canEndConversation() to block both.
     */</span>
    canEndConversation(actor, reason)
    {
        if(reason == endConvTravel)
            &quot;&lt;q&gt;Don't walk away when I'm talking with you!&lt;/q&gt; {the sally/she}
            protests, &lt;q&gt;I asked you a question: do you want me to show you the
            lighthouse or don't you?&lt;/q&gt; &quot;;
        if(reason == endConvBye)
            &quot;&lt;q&gt;Don't you &lt;q&gt;goodbye&lt;/q&gt; me when I ask you a question!&lt;/q&gt; {the
            sally/she} storms, &lt;q&gt;Now, are you coming with me to the lighthouse
            or aren't you?&lt;/q&gt; &quot;;
        
        <span class='comment'>/*  
         *   blockEndConv is a special value which not only doesn't allow the
         *   conversation to be ended while we're in this ConvNode but also 
         *   tells the caller that we've displayed a message explaining why, 
         *   so that we don't also need to display one of the messages from 
         *   npcContinueList/
         */</span>
        return blockEndConv;
    }
    
    <span class='comment'>/*  
     *   There's no way the compiler can readily tell if this is an 'open' 
     *   ConvNode or a 'closed' one. If it were 'open' the player could also 
     *   reach TopicEntries defined outside this ConvNode, so we'd want them 
     *   to be suggested too. In this case we've made it a 'closed' ConvNode 
     *   by adding a DefaultAnyTopic (see below) which keeps Sally in this 
     *   ConvNode until we explicitly say otherwise.
     */</span>    
    limitSuggestions = true
    
    <span class='comment'>/*   
     *   Normally, we'd leave a ConvNode as soon as the player entered a 
     *   conversational command. That's the behaviour we'd want for an 'open'
     *   node. But since this is a closed one we don't want a conversational
     *   command to make us leave this ConvNode unless we explicitly say so,
     *   so we make this ConvNode sticky.
     */</span>
    isSticky = true
;

<span class='comment'>/*  
 *   YES TOPIC
 *
 *   A YesTopic handles the response when the player types YES. Normally a 
 *   YesTopic will only be useful in a ConvNode (to handle a reply to a 
 *   question the NPC has just asked. Making it a SuggestedYesTopic also 
 *   means that 'say yes' will be one of the suggestions offered to the 
 *   player/
 */</span>
++ YesTopic, SuggestedYesTopic
    topicResponse()
    {
        <span class='comment'>/*  
         *   If the player replies YES, we want to leave this ConvNode. 
         *   Since the ConvNode is sticky we can only do that by changing to 
         *   another ConvNode. There's no ConvNode called 'nil' so the tag 
         *   &lt;.convnode nil&gt; takes us out of this ConvNode without 
         *   activating another one. Using any non-existent node name would 
         *   have done just as well, but 'nil' makes it clear what we're 
         *   doing -- provided we never use 'nil' as a ConvNode name!
         */</span>
        &quot;&lt;q&gt;Yes, all right, take me to the lighthouse,&lt;/q&gt; you say.\b
        &lt;q&gt;Follow me,&lt;/q&gt; she replies, starting towards the east. &lt;.convnode
        nil&gt;&quot;;
        
        <span class='comment'>/*   
         *   If the player says YES, Sally will lead him to the lighthouse, 
         *   so we need to put her in the first of her GuidedTourStates.
         */</span>
        sally.setCurState(sallyTour1State);
    }
;

<span class='comment'>/*   
 *   NO TOPIC
 *
 *   A NoTopic is just like a YesTopic, except that it handles a response to 
 *   NO.
 */</span>
++ NoTopic, SuggestedNoTopic
    topicResponse()
    {
        &quot;&lt;q&gt;No, I'm a bit busy right now,&lt;/q&gt; you say.\b
        &lt;q&gt;Very well, suit yourself,&lt;/q&gt; she shrugs, &lt;q&gt;It's your loss, not
        mine,&lt;/q&gt;&lt;.convnode nil&gt;\b
        So saying, she turns away; and with her goes your only chance of
        learning about the lighthouse and the troubles.\b&quot;;
        
        <span class='comment'>/* 
         *   If the PC refuses to follow Sally, then the plot (such as it 
         *   is) has been derailed, so we may as well end the game. We do so 
         *   with a suitable custom message.
         */</span>        
        finishGameMsg('YOU ARE FEEBLY FAINT-HEARTED', [finishOptionUndo]);
        
    }
;

<span class='comment'>/*  
 *   SPECIAL TOPIC
 *
 *   A SpecialTopic is a special kind of TopicEntry that can only be used 
 *   inside a ConvNode. It allows the player to respond with things that 
 *   normally wouldn't be possible in the standard ASK/TELL system. The 
 *   SpecialTopic we define immediately below will be suggested to the 
 *   player as &quot;as why she's offering.&quot;
 */</span>
++ SpecialTopic, StopEventList 'ask why she\'s offering'
    <span class='comment'>/* 
     *   The list of keywords that can be used to trigger this SpecialTopic. 
     *   We need to make sure that the exact phrasing of the suggestion 
     *   works, but we also need to bear in mind that more players than not 
     *   will insist on trying some other phrasing and consider it a bug 
     *   when it doesn't work, so we need to cater for the obvious variants 
     *   as well. The SpecialTopic will be matched so long as all the words 
     *   entered by the player are in this list of keywords, so this will 
     *   match ASK HER WHY or WHY ARE YOU OFFERING (for example) as well as 
     *   the phrasing actually suggested.
     */</span>
    ['ask', 'her', 'why', 'she', 'she\'s', 'offering', 'are', 'you']
    [
        '&lt;q&gt;Why are you offering to show me?&lt;/q&gt; you ask.\b
        &lt;q&gt;Because you\'re new here; you need to understand what happened,&lt;/q&gt;
        she replies. &lt;q&gt;So, are you coming? Yes or no?&lt;/q&gt;',
        
        '&lt;q&gt;I still don\'t understand why you\'re so keen to show me the
        lighthouse,&lt;/q&gt; you say.\b
        &lt;q&gt;Like I said, you need to understand what happened there. So, do you
        want me to show you?&lt;/q&gt; '
        
    ]
;
    
<span class='comment'>/* 
 *   If the PC doesn't yet know who Sally is (he could have found out from 
 *   Bob), we'll let him ask her.
 */</span>
++ AskTopic, SuggestedAskTopic @sally
    &quot;&lt;q&gt;Who are you?&lt;/q&gt; you ask.\b
    &lt;q&gt;I'm &lt;&lt;sally.makeProper()&gt;&gt;,&lt;/q&gt; she replies briskly, &lt;q&gt;and I've been
    around here long enough to know a thing or two. So, do you want me to take
    you to the lighthouse?&lt;/q&gt; &quot;
    isActive = (!sally.isProperName)
    name = 'herself'
;

<span class='comment'>/*   
 *   DEFAULT ANY TOPIC
 *
 *   This DefaultAnyTopic ensures that this ConvNode remains 'closed', since 
 *   it will be triggered in response to any conversational command except 
 *   for the four explicitly handled above. Without one or more 
 *   DefaultTopics to trap other conversational commands, they would be 
 *   handled by the next TopicDatabase (ActorState or Actor) in the 
 *   hierarchy, and we'd slip straight out of the ConvNode.
 *
 *   In a real game we'd probably want to make the DefaultAnyTopic a 
 *   ShuffledEventList to vary the responses.
 */</span> 
++ DefaultAnyTopic
    &quot;&lt;q&gt;Never mind that,&lt;/q&gt; she says, &lt;q&gt;I asked you if you wanted me to show
    you the lighthouse. Do you?&lt;/q&gt; &quot;
;
    
//------------------------------------------------------------------------------
<span class='comment'>/*   
 *   AN 'OPEN' CONVERSATION NODE 
 *
 *   This is the conversation node that's triggered when Sally and the PC 
 *   arrive outside the lighthouse. She asks the PC whether they should go 
 *   inside, but that's an invitation to action rather than a demand for a 
 *   verbal response, so though we should cater for a verbal response, we 
 *   shouldn't demand one. So we can use the much simpler 'open' ConvNode 
 *   coding structure here.
 */</span>
+ ConvNode 'lighthouse'
    <span class='comment'>/* The message to display when Sally enters this ConvNode. */</span>
    npcGreetingMsg = &quot;&lt;q&gt;Well, here we are then,&lt;/q&gt; she tells you, &lt;q&gt;This is
       where it all started. Shall we go inside?&lt;/q&gt;&quot;    
;

++ YesTopic, SuggestedYesTopic
    &quot;&lt;q&gt;Yes; that's what came for, isn't it?&lt;/q&gt; you reply.\b
    &lt;q&gt;Quite,&lt;/q&gt; she agrees, &lt;q&gt;So lead on!&lt;/q&gt; &quot;    
;

++ NoTopic, SuggestedNoTopic
    &quot;&lt;q&gt;No, I don't like the look of it,&lt;/q&gt; you reply.\b
    &lt;q&gt;Don't be a ninny!&lt;/q&gt; she protests, &lt;q&gt;It's quite safe! So -- lead
    on!&lt;/q&gt;&quot;
;

++ AskTopic, SuggestedAskTopic @lighthouse
    &quot;&lt;q&gt;What will we find in there?&lt;/q&gt; you ask.\b
    &lt;q&gt;Why don't we go in and see?&lt;/q&gt; she replies, &lt;q&gt;Shall we?&lt;/q&gt; &lt;.convstay&gt;
    &quot;
    name = 'the lighthouse'
;

<span class='comment'>/* 
 *   There's no DefaultTopic at the end of this ConvNode structure. If the 
 *   player responds with anything other than YES, NO or ASK ABOUT 
 *   LIGHTHOUSE, we'll simply fall straight out of the ConvNode, since we'll 
 *   have left the point of the conversation at which any of these responses 
 *   made sense.
 */</span>


//------------------------------------------------------------------------------
<span class='comment'>/*   
 *   A THREADED CONVERSATION NODE CHAIN
 *
 *   We can also use ConvNodes to created a threaded conversational chain. 
 *   This could be done with 'closed' nodes, but quickly becomes very 
 *   laborious (perhaps for the player as well as the author!). Here we just 
 *   illustrate a chain of very simple 'open' nodes. Note that the 
 *   conversation will only continue on to the next node in the chain if the 
 *   player gives the 'correct' answer on every turn (though we could have 
 *   programmed a branching chain had we wanted to). In this case this is a 
 *   reasonable model of how such a conversation might proceed.
 */</span>

+ ConvNode 'family'
    <span class='comment'>/* 
     *   Note that we don't have to define any other properties of this 
     *   ConvNode. Sally has already asked the question that triggered this 
     *   ConvNode so we don't even need to supply an npcGreetingMsg.
     */</span>
;

++ YesTopic, SuggestedYesTopic
    &quot;&lt;q&gt;Yes, I've just moved here with my wife and kids,&lt;/q&gt; you say.\b
    &lt;q&gt;Well, I hope you like it here!&lt;/q&gt; she replies.&lt;.reveal married&gt; &quot;
;

++ NoTopic, SuggestedNoTopic
    <span class='comment'>/* 
     *   The tag &lt;.convnode drink&gt; at the end of this reply will take the 
     *   Conversation to the next ConvNode (called 'drink').
     */</span>
    &quot;&lt;q&gt;No, I'm a bachelor,&lt;/q&gt; you reply.\b
    &lt;q&gt;Really?&lt;/q&gt; she replies, &lt;q&gt;I'd've thought a guy like you -- well, maybe
    we could have a drink some time, and you can tell me all about it.&lt;/q&gt;
    &lt;.convnode drink&gt; &quot;
;

+ ConvNode 'drink'
;

++ YesTopic, SuggestedYesTopic
    &quot;&lt;q&gt;Yes, I'd like that,&lt;/q&gt; you say.\b
    &lt;q&gt;Good!&lt;/q&gt; she smiles, &lt;q&gt;How about tonight? I know a great little place
    we could go, so, if you're free...&lt;/q&gt; &lt;.convnode date&gt;&quot;
;

++ NoTopic, SuggestedNoTopic
    &quot;&lt;q&gt;No, I'd better not. My girlfriend probably wouldn't understand,&lt;/q&gt; you
    tell her.\b
    &lt;q&gt;Oh, very well then,&lt;/q&gt; she replies. &quot;
;

+ ConvNode 'date'
;

++ YesTopic, SuggestedYesTopic
    &quot;&lt;q&gt;Yes, I'm free tonight,&lt;/q&gt; you say, &lt;q&gt;let's meet up for a drink
    then!&lt;/q&gt;\b
    &lt;q&gt;It's a date!&lt;/q&gt; she declares with a broad grin. &quot;
;

++ NoTopic, SuggestedNoTopic
    &quot;&lt;q&gt;No, I'm busy tonight,&lt;/q&gt; you reply, &lt;q&gt;just moved it, so many things to
    attend to...&lt;/q&gt;\b
    &lt;q&gt;Some other time then, maybe,&lt;/q&gt; she suggests. &lt;.convnode other&gt;&quot;    
;

+ ConvNode 'other'
;

++ SpecialTopic 'suggest tomorrow' ['suggest', 'how', 'about', 'tomorrow']
    &quot;&lt;q&gt;How about tomorrow?&lt;/q&gt; you suggest.\b
    &lt;q&gt;That would be great -- it's a date!&lt;/q&gt; she beams. &quot;
;

++ SpecialTopic 'answer vaguely' ['answer', 'vaguely', 'be', 'vague']
    &quot;&lt;q&gt;Yes, some other time,&lt;/q&gt; you agree. &quot;
;


//==============================================================================
<span class='comment'>/*  
 *   AGENDA ITEMS
 *
 *   AgendaItems provide a mechanism to allow NPCs to pursue goal-directed 
 *   behaviour or responded to particular events. Each NPC has an agendaList 
 *   (which may, of course, be empty at any one time), and on each turn when 
 *   the NPC is not otherwise engaged his/her/its agendaList is searched for 
 *   an AgendaItem that's ready to be used. If one is found, it's 
 *   invokeItem() method is called. 
 *
 *   We want Sally to walk out of the shop and wait for the PC as soon as she
 *   hears Bob mention the lighthouse. An AgendaItem is ideal for this.
 */</span>

+ AgendaItem
    <span class='comment'>/* 
     *   AgendaItems normally have to be added to an NPC's AgendaList 
     *   explicitly, but by setting this property to true we can have an 
     *   AgendaItem automatically added to the agendaList at the start of 
     *   the game, which is what we want here.
     */</span>
    initiallyActive = true
    
    <span class='comment'>/*   
     *   An AgendaItem can fire once its isReady property is true. The PC 
     *   learns about the lighthouse when Bob first mentions it, so checking 
     *   for when the PC knows about the lighthouse should make this 
     *   AgendaItem fire at the right time.
     */</span>
    isReady = (me.knowsAbout(lighthouse))
    
    <span class='comment'>/*   The code to execute once this AgendaItem is triggered. */</span>
    invokeItem
    {
        <span class='comment'>/*  
         *   Note that text displayed in the invokeItem() of an AgendaItem 
         *   will only be displayed if the PC can see the NPC in question. 
         *   Normally this is what we want, since it allows us to describe 
         *   what an NPC is doing without worrying if the PC is there to see 
         *   it or not (if the PC isn't, the text won't be displayed), but 
         *   occasionally this can catch us out, not least if the 
         *   invokeItem() method moves the NPC in or out of the PC's scope 
         *   in the course of execution.
         *
         *   Here, though, it's straightforward, since the PC will always be 
         *   present to see Sally's reaction to the mention of the lighthouse.
         */</span>
        &quot;{The sally/she} pauses from her clothes-hunting and throws you an
        anxious glance. &quot;;
        
        <span class='comment'>/*  Make Sally leave the shop. */</span>
        sally.scriptedTravelTo(street);
        
        <span class='comment'>/*  Change Sally's ActorState to sallyStreetState */</span>
        sally.setCurState(sallyStreetState);
        
        <span class='comment'>/*  Add a new AgendaItem to Sally's agendaList. */</span>
        sally.addToAgenda(sallyStreetAgenda);
        
        <span class='comment'>/*  
         *   We're done with this AgendaItem, so it can be removed from 
         *   Sally's agendaList; we show this by setting isDone = true. If 
         *   we didn't this AgendaItem would keep on firing while its 
         *   isReady property evaluated to true. 
         *
         *   In come cases we might want an AgendaItem to be triggered over 
         *   several terms, in which case we wouldn't set isDone = true 
         *   until we were done with it; but this AgendaItem is a one-off, 
         *   so we set isDone = true first time through.
         */</span>
        isDone = true;
    }
;

<span class='comment'>/*   
 *   CONV AGENDA ITEM
 *
 *   A ConvAgendaItem is used to allow the NPC to try to say something on 
 *   his or her own initiative. By default it becomes ready when (a) the NPC 
 *   is in a position to talk to the PC and (b) the PC hasn't conversed with 
 *   the NPC on that turn. When those two conditions are met the NPC can 
 *   inject her conversational gambit into the conversation. 
 *
 *   We want Sally to offer to lead the PC to the lighthouse as soon as he 
 *   emerges from the shop. A ConvAgenaItem will do this job for us, since 
 *   the Sally can't talk to the PC when he's inside the shop and she's 
 *   outside, but will be able to as soon as he comes out of the shop. 
 */</span>

+ sallyStreetAgenda: ConvAgendaItem
    invokeItem()
    {                
        <span class='comment'>/* 
         *   Initiate a conversation using the 'troubles' ConvNode without 
         *   changing the current ActorState.
         */</span>
        sally.initiateConversation(nil, 'troubles');
        
        <span class='comment'>/* This is a once-off AgendaItem, so note we're done with it. */</span>
        isDone = true;
    }
;

<span class='comment'>/*
 *   DELAYED AGENDA ITEM
 *
 *   A DelayedAgendaItem is one that fires a predetermined number of turns 
 *   after its added to its actor's agendaList.
 *
 *   If the PC wanders around for too long after entering the lighthouse 
 *   without going to the room Sally wants him to visit, she'll become 
 *   impatient enough to give him a verbal nudge. Since this is a 
 *   conversational activity, it's appropriate to make this a ConvAgendaItem 
 *   as well. Note that we can just mix the two classes together to combine 
 *   their behaviour.
 */</span>


+ sallyImpatientAgenda: DelayedAgendaItem, ConvAgendaItem
    invokeItem()
    {
        if(me.hasSeen(oakDoor))
            &quot;&lt;.p&gt;&lt;q&gt;If you want answers you &lt;i&gt;have&lt;/i&gt; to go through that oak
            door,&lt;/q&gt; {the sally/she} tells you. &quot;;
        else
            &quot;&lt;.p&gt;&lt;q&gt;You won't find anything down here,&lt;/q&gt; {the sally/she} tells
            you, &lt;q&gt;we'll have to try upstairs.&lt;/q&gt; &quot;;
        
        isDone = true;
    }
;


//==============================================================================
<span class='comment'>/*   
 *   TOPIC
 *
 *   A Topic is used to represent a possible Topic of Conversation that's not
 *   otherwise represented as a physical object in the game world, either 
 *   because it's an abstraction (like 'weather' or 'troubles') or because 
 *   there's no physical object by that name corresponding to it in the game 
 *   (like the town).
 *
 *   Here we define just three Topics. A real game would probably define many
 *   more. Note that starting the name of a Topic object with a lower-case 
 *   t is not a requirement, it's simply a convention adopted here/
 *
 *   Note also that the only property we need to define on a Topic object is 
 *   its vocabWords (the single-quoted string in the Topic template). 
 */</span>

tWeather: Topic 'weather';
tTown: Topic 'this town/place';
tTroubles: Topic 'troubles';
</pre></div>

<div class="nav">
  <a class="nav" href="exercises.htm">Examples Index</a> | <a href='Exercise20.htm'>adv3Lite version</a>
  
  </div>
  <hr>
</body>
</html>
